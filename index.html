<!DOCTYPE html>
<html>
<head>
    <title>Position du véhicule</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { height: 100%; width: 100%; }
    </style>
    <script>
      const params = new URLSearchParams(window.location.search);

      function displayMap(lat, lng, accuracy) {
          const position = { lat, lng };

          const map = new google.maps.Map(document.getElementById('map'), {
              zoom: 16,
              center: position
          });

          new google.maps.marker.AdvancedMarkerElement({
              position,
              map,
              title: "Position du véhicule"
          });

          new google.maps.Circle({
              map,
              center: position,
              radius: accuracy,
              fillColor: '#4285F4',
              fillOpacity: 0.2,
              strokeColor: '#4285F4',
              strokeOpacity: 0.8,
              strokeWeight: 2
          });
      }

      async function initMap() {
          const paramsAvailable = ['cellId', 'locationAreaCode', 'mobileCountryCode', 'mobileNetworkCode']
              .every(param => params.has(param));

          if (paramsAvailable) {
              const requestBody = {
                  cellTowers: [{
                      cellId: parseInt(params.get('cellId')),
                      locationAreaCode: parseInt(params.get('locationAreaCode')),
                      mobileCountryCode: parseInt(params.get('mobileCountryCode')),
                      mobileNetworkCode: parseInt(params.get('mobileNetworkCode'))
                  }]
              };

              fetch('https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyCWtjRh35Td4mJg6rVPkM8jadO8K-CvmLc', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(requestBody)
              })
              .then(response => response.json())
              .then(data => displayMap(data.location.lat, data.location.lng, data.accuracy))
              .catch(error => {
                  alert('Erreur lors de la géolocalisation : ' + error.message);
                  console.error(error);
              });

          } else if (params.get('lat') && params.get('lng') && params.get('accuracy')) {
              displayMap(
                  parseFloat(params.get('lat')),
                  parseFloat(params.get('lng')),
                  parseFloat(params.get('accuracy'))
              );
          } else {
              alert('Paramètres de localisation manquants ou incorrects.');
          }
      }

      function loadGoogleMapsScript() {
          const script = document.createElement('script');
          scriptURL = "https://maps.googleapis.com/maps/api/js?key=AIzaSyApy_i3n8O8e0PXjSrgsjcIwm3puntDvy8&callback=init";
          script = document.createElement('script');
          script.src = script;
          script.async = true;
          document.head.appendChild(script);
      }

      window.onload = loadGoogleMaps;

      function init() {
          const checkGoogle = setInterval(() => {
              if (window.google && google.maps) {
                  clearInterval(interval);
                  main();
              }
          }, 100);

          function init() {
              if (typeof google !== 'undefined' && google.maps) {
                  const paramsAvailable = ['cellId', 'locationAreaCode', 'mobileCountryCode', 'mobileNetworkCode']
                    .every(param => params.has(param));

                  if (paramsAvailable || (params.get('lat') && params.get('lng') && params.get('accuracy'))) {
                      mainInit();
                  } else {
                      alert('Paramètres de localisation manquants ou incorrects.');
                  }
              }
          }

          function mainInit() {
              loadGoogleMapsScript();
          }

          window.onload = mainInit;

      function init() {
          const paramsAvailable = ['cellId', 'locationAreaCode', 'mobileCountryCode', 'mobileNetworkCode']
              .every(param => params.has(param));

          if (paramsAvailable) {
              const requestBody = {
                  cellTowers: [{
                      cellId: parseInt(params.get('cellId')),
                      locationAreaCode: parseInt(params.get('locationAreaCode')),
                      mobileCountryCode: parseInt(params.get('mobileCountryCode')),
                      mobileNetworkCode: parseInt(params.get('mobileNetworkCode'))
                  }]
              };

              fetch('https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyCWtjRh35Td4mJg6rVPkM8jadO8K-CvmLc', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(requestBody)
              })
              .then(response => response.json())
              .then(data => displayMap(data.location.lat, data.location.lng, data.accuracy))
              .catch(error => alert("Erreur de géolocalisation : " + error));

          } else if (params.has('lat') && params.has('lng') && params.has('accuracy')) {
              displayMap(
                  parseFloat(params.get('lat')),
                  parseFloat(params.get('lng')),
                  parseFloat(params.get('accuracy'))
              );
          } else {
              alert('Paramètres de localisation manquants ou incorrects.');
          }
      }

      window.onload = function() {
          const script = document.createElement('script');
          script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyApy_i3n8O8e0PXjSrgsjcIwm3puntDvy8&callback=init';
          script.async = true;
          document.head.appendChild(script);
      };
    </script>
</head>
<body>
    <div id="map"></div>
</body>
</html>
